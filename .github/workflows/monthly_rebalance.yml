name: Monthly Momentum Rebalance

# Runs on 1st-3rd of each month at 4:30 PM ET
# Executes monthly rebalance trades

on:
  schedule:
    # Run on 1st, 2nd, 3rd of each month (catches first trading day)
    - cron: '30 21 1-3 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rebalance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Cache Market Data
      id: cache-market-data
      uses: actions/cache@v4
      with:
        path: |
          data/market.db
          data/universe_cache.csv
        key: market-data-${{ runner.os }}-${{ github.run_id }}
        restore-keys: |
          market-data-${{ runner.os }}-

    - name: Build Docker Image
      run: docker build -t paper-trader .

    - name: Check if First Trading Day
      id: check-day
      run: |
        # Simple check - if it's weekend, skip
        DOW=$(date +%u)
        if [ "$DOW" -gt 5 ]; then
          echo "ðŸ—“ï¸ Weekend - skipping rebalance"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "ðŸ“ˆ Trading day - proceeding with rebalance"
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Monthly Rebalance
      if: steps.check-day.outputs.skip != 'true'
      run: |
        echo "ðŸ”„ Running Monthly Momentum Rebalance..."
        docker run --rm -v ${{ github.workspace }}:/app paper-trader \
          conda run --no-capture-output -n paper-trader \
          python main.py --mode trade --strategy momentum

    - name: Push Changes
      if: steps.check-day.outputs.skip != 'true'
      run: |
        git config --global user.name 'PAT0216'
        git config --global user.email '69978508+PAT0216@users.noreply.github.com'
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        
        # Add all relevant files
        git add -f ledger.csv 2>/dev/null || true
        git add -f logs/portfolio_daily.csv 2>/dev/null || true
        
        # Get current branch
        BRANCH_NAME="${GITHUB_REF_NAME}"
        
        # Fetch and rebase
        git fetch origin "$BRANCH_NAME" || true
        git stash --include-untracked || true
        git pull --rebase origin "$BRANCH_NAME" || true
        git stash pop 2>/dev/null || true
        
        # Re-add after rebase
        [ -f ledger.csv ] && git add ledger.csv
        
        # Commit and push
        git diff --staged --quiet || (git commit -m "ðŸ“ˆ Monthly Momentum Rebalance $(date +'%Y-%m')" && git push origin HEAD:"$BRANCH_NAME" --force-with-lease)
